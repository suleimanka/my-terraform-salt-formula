{%- import_yaml "terraform/defaults.yaml" as default_settings -%}
{%- set user_settings = salt["pillar.get"]("terraform", {}) -%}
{%- set terraform = default_settings["Defaults"] | combine(user_settings, recursive=True) -%}

{# Автоопределение архитектуры #}
{% if not terraform.arch %}
  {%- set archgrain = grains.get("osarch") or grains.get("cpuarch") -%}
  {% if archgrain in ["x86_64","AMD64"] %}
    {%- set terraform = terraform | combine({"arch":"amd64"}, recursive=True) -%}
  {% elif archgrain in ["aarch64","arm64"] %}
    {%- set terraform = terraform | combine({"arch":"arm64"}, recursive=True) -%}
  {% else %}
    {%- set terraform = terraform | combine({"arch":archgrain or "amd64"}, recursive=True) -%}
  {% endif %}
{% endif %}

{# Выбор default_version, если не задан #}
{% if not terraform.default_version and terraform.versions %}
  {%- set dv = terraform.versions[0] -%}
  {%- set terraform = terraform | combine({"default_version": dv}, recursive=True) -%}
{% endif %}

{# Построение списка артефактов с URL и sha256 #}
{%- set artifacts = {} -%}
{% for ver in terraform.versions %}
  {%- set u = terraform.base_url ~ '/' ~ ver ~ '/terraform_' ~ ver ~ '_linux_' ~ terraform.arch ~ '.zip' -%}
  {% if terraform.download_urls.get(ver) %}
    {%- set u = terraform.download_urls[ver] -%}
  {% endif %}
  {%- set sha = terraform.checksums.get(ver, None) -%}
  {%- do artifacts.update({ver: {"url":u,"sha256":sha}}) -%}
{% endfor %}
{%- set terraform = terraform | combine({"artifacts":artifacts}, recursive=True) -%}
{%- set _ = context.update({"terraform": terraform}) -%}
